version: v1.0
name: Flowcrypt Node Core Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:

  - name: Invalidate
    execution_time_limit:
      minutes: 1
    task:
      jobs:
        - name: Invalidate cache
          commands:
            - cache delete sources

  - name: Pull
    execution_time_limit:
      minutes: 2
    task:
      env_vars:
        - name: SEMAPHORE_GIT_DIR
          value: /home/semaphore/git/flowcrypt-mobile-core
      jobs:
        - name: Assemble sources
          commands:
            - mkdir ~/git
            - checkout
            - cd ~/git && git clone --depth=1 https://github.com/FlowCrypt/flowcrypt-node-modules.git
            - cd ~ && cache store sources ./git

  - name: Install
    execution_time_limit:
      minutes: 5
    task:
      jobs:
        - name: Npm install
          commands:
            - cache restore sources
            - cd ~/git/flowcrypt-node-modules && npm install
            - cd ~/git/flowcrypt-mobile-core/TypeScript && npm install
            - cd ~ && cache delete sources && cache store sources ./git

  - name: Test
    execution_time_limit:
      minutes: 5
    task:
      jobs:
        - name: Build and Test
          commands:
            - cache restore sources
            - cd ~/git/flowcrypt-mobile-core/TypeScript && npm run-script test
